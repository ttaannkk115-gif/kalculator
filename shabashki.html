<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOLT MASTER - CLOUD –®–ê–ë–ê–®–ö–ò</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        :root {
            --main-gold: #ffc107;
            --dark-bg: #0f0f0f;
            --card-bg: rgba(255, 255, 255, 0.07);
            --text-main: #ffffff;
            --text-dim: #999999;
            --success: #4caf50;
            --process: #2196f3;
            --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; background: var(--dark-bg);
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 100%);
            color: var(--text-main); 
            padding-bottom: 120px;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        header { padding: 20px 20px 10px; text-align: center; }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin: 0; }
        .logo span { color: var(--main-gold); }
        .sub-header { font-size: 10px; color: #444; letter-spacing: 3px; margin-top: 5px; text-transform: uppercase; }

        .status-badge {
            display: inline-flex; align-items: center;
            background: rgba(255, 193, 7, 0.08); color: #fff;
            padding: 6px 15px; border-radius: 20px;
            font-size: 11px; margin-top: 10px; border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .city-tabs {
            display: flex; gap: 8px; overflow-x: auto; padding: 10px 15px 20px;
            scrollbar-width: none;
        }
        .city-tabs::-webkit-scrollbar { display: none; }
        
        .tab {
            background: rgba(255,255,255,0.05); border: 1px solid #333;
            color: #888; padding: 8px 18px; border-radius: 20px;
            font-size: 12px; font-weight: bold; white-space: nowrap; transition: 0.3s;
        }
        .tab.active { background: var(--main-gold); color: #000; border-color: var(--main-gold); }

        .card {
            background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px; padding: 18px; margin: 0 15px 12px; position: relative;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .my-order { border-left: 4px solid var(--main-gold); }
        .status-taken { border-color: var(--process); background: rgba(33, 150, 243, 0.05); }

        .badge-status {
            font-size: 9px; padding: 4px 8px; border-radius: 6px; font-weight: bold;
            display: inline-block; margin-bottom: 10px; text-transform: uppercase;
        }
        .bg-free { background: rgba(255,255,255,0.1); color: #fff; }
        .bg-busy { background: rgba(33, 150, 243, 0.2); color: var(--process); }

        .card-header { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 8px; }
        .tag-city { color: var(--main-gold); font-weight: bold; }
        
        h3 { margin: 5px 0; font-size: 17px; }
        .addr { color: var(--text-dim); font-size: 13px; margin-bottom: 12px; }

        /* –ò–°–¢–û–†–ò–Ø –û–¢–ö–ê–ó–û–í */
        .rejection-history {
            background: rgba(255, 68, 68, 0.05);
            border: 1px dashed rgba(255, 68, 68, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .rej-item {
            font-size: 11px;
            padding: 5px 0;
            border-bottom: 1px dotted rgba(255, 68, 68, 0.2);
        }
        .rej-item:last-child { border-bottom: none; }
        .rej-label { color: var(--danger); font-weight: bold; font-size: 9px; text-transform: uppercase; }

        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-main { background: var(--main-gold); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: rgba(255,255,255,0.05); color: #fff; margin-top: 8px; border: 1px solid #333; }
        .btn-disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        nav {
            position: fixed; bottom: 0; width: 100%; 
            background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-around; padding: 15px 0 25px 0; z-index: 1000;
        }
        nav button { background: none; border: none; color: #555; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
        nav button.active { color: var(--main-gold); }
        nav button i { font-style: normal; font-size: 20px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal { background: #161616; padding: 25px; border-radius: 20px; width: 85%; border: 1px solid #333; }
        .hidden { display: none; }
        input, select, textarea { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 12px; padding: 14px; color: #fff; width: 100%; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
        
        .admin-tools { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        .btn-small { padding: 6px; font-size: 9px; background: #222; color: #777; border-radius: 6px; flex: 1; border: none; }
    </style>
</head>
<body>

<header>
    <div class="logo">VOLT<span>MASTER</span></div>
    <div class="sub-header">CLOUD –®–ê–ë–ê–®–ö–ò</div>
    <div class="status-badge"><span id="my-id-display">ID...</span></div>
</header>

<div class="city-tabs" id="city-tabs-ui">
    <div class="tab active" onclick="setFilter('–í—Å–µ', this)">–û–ë–©–ò–ô</div>
    <div class="tab" onclick="setFilter('–ú–∞—Ö–∞—á–∫–∞–ª–∞', this)">–ú–ê–•–ê–ß–ö–ê–õ–ê</div>
    <div class="tab" onclick="setFilter('–ö–∞—Å–ø–∏–π—Å–∫', this)">–ö–ê–°–ü–ò–ô–°–ö</div>
    <div class="tab" onclick="setFilter('–ë—É–π–Ω–∞–∫—Å–∫', this)">–ë–£–ô–ù–ê–ö–°–ö</div>
</div>

<div id="view-list"><div id="orders-list"></div></div>
<div id="view-archive" class="hidden"><div id="archive-list"></div></div>

<div id="view-add" class="hidden" style="padding: 20px;">
    <h2 style="font-size: 18px; margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
    <input type="hidden" id="edit-id">
    <select id="city-input">
        <option value="–ú–∞—Ö–∞—á–∫–∞–ª–∞">–ú–∞—Ö–∞—á–∫–∞–ª–∞</option>
        <option value="–ö–∞—Å–ø–∏–π—Å–∫">–ö–∞—Å–ø–∏–π—Å–∫</option>
        <option value="–ë—É–π–Ω–∞–∫—Å–∫">–ë—É–π–Ω–∞–∫—Å–∫</option>
    </select>
    <input type="text" id="task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞, –¥–æ–º)">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__" maxlength="18">
    <button class="btn btn-main" onclick="saveOrder()" id="save-btn" style="margin-top: 10px;">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
</div>

<div id="modal-rej" class="modal-overlay">
    <div class="modal">
        <h3 style="color:var(--main-gold)">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</h3>
        <textarea id="rej-text" rows="4" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É..."></textarea>
        <button class="btn btn-main" onclick="submitRejection()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        <button class="btn btn-outline" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<nav>
    <button onclick="changeView('list', this)" class="active"><i>üìã</i>–ó–ê–ö–ê–ó–´</button>
    <button onclick="changeView('add', this)"><i>‚ûï</i>–°–û–ó–î–ê–¢–¨</button>
    <button onclick="changeView('archive', this)"><i>üìÅ</i>–ê–†–•–ò–í</button>
</nav>

<script>
    const firebaseConfig = { databaseURL: "https://kalculator-8e345-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MY_ID = localStorage.getItem('user_id_2026') || "USER-" + Math.floor(Math.random()*9000);
    localStorage.setItem('user_id_2026', MY_ID);
    document.getElementById('my-id-display').innerText = "–í–ê–® ID: " + MY_ID;

    const WAIT_TIME = 30 * 60 * 1000;
    let currentFilter = '–í—Å–µ';
    let allOrders = [];
    let currentRejId = null;

    document.getElementById('phone').addEventListener('input', (e) => {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
        if (!x[2]) { e.target.value = x[1] ? '+7 (' : ''; }
        else { e.target.value = '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : ''); }
    });

    function initSync() {
        db.ref('shabashki/active').on('value', snap => {
            const data = snap.val() || {};
            allOrders = Object.values(data).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
            renderFiltered();
        });
        db.ref('shabashki/archive').limitToLast(20).on('value', snap => {
            const data = snap.val() || {};
            renderArchive(Object.values(data).sort((a,b) => b.timestamp - a.timestamp));
        });
        setInterval(renderFiltered, 60000);
    }

    function setFilter(city, btn) {
        currentFilter = city;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        renderFiltered();
    }

    function renderFiltered() {
        const filtered = currentFilter === '–í—Å–µ' ? allOrders : allOrders.filter(o => o.city === currentFilter);
        render(filtered);
    }

    function render(orders) {
        const container = document.getElementById('orders-list');
        container.innerHTML = orders.length ? '' : '<div style="text-align:center;color:#444;margin-top:50px;">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</div>';
        
        orders.forEach(o => {
            const isMe = o.author === MY_ID;
            const isBusy = o.status === 'busy';
            const card = document.createElement('div');
            card.className = `card ${isMe ? 'my-order' : ''} ${isBusy ? 'status-taken' : ''}`;
            
            // –í–´–í–û–î –í–°–ï–• –ü–†–ò–ß–ò–ù –û–¢–ö–ê–ó–ê
            let rejectionsHtml = '';
            if (o.rejections) {
                let items = Object.values(o.rejections).map(r => `
                    <div class="rej-item">
                        <span class="rej-label">–û—Ç–∫–∞–∑:</span> ${r.text}
                    </div>
                `).join('');
                rejectionsHtml = `<div class="rejection-history">${items}</div>`;
            }

            let html = `
                <div class="card-header"><span class="tag-city">${o.city}</span><span style="color:#555">${o.date}</span></div>
                <span class="badge-status ${isBusy ? 'bg-busy' : 'bg-free'}">${isBusy ? '‚è≥ –í —Ä–∞–±–æ—Ç–µ —É: '+o.worker : 'üîò –°–≤–æ–±–æ–¥–µ–Ω'}</span>
                <h3>${o.task}</h3><div class="addr">üìç ${o.addr}</div>
                ${rejectionsHtml}
            `;

            if(isBusy && o.worker === MY_ID) {
                const now = Date.now();
                const diff = now - (o.takenAt || 0);
                const canFinish = diff >= WAIT_TIME;
                const minLeft = Math.ceil((WAIT_TIME - diff) / 60000);

                html += `
                    <div style="background:rgba(255,193,7,0.1); padding:15px; border-radius:12px; text-align:center; margin-bottom:12px; border: 1px solid rgba(255,193,7,0.2);">
                        <a href="tel:${o.phone}" style="color:var(--main-gold); text-decoration:none; font-weight:800; font-size:20px;">${o.phone}</a>
                    </div>
                    <button class="btn btn-success ${canFinish ? '' : 'btn-disabled'}" onclick="finishOrder('${o.id}')">
                        ${canFinish ? '–ó–ê–í–ï–†–®–ò–¢–¨ –û–ë–™–ï–ö–¢' : `–ñ–î–ò–¢–ï ${minLeft} –ú–ò–ù`}
                    </button>
                    <button class="btn btn-outline" onclick="openRej('${o.id}')">–û–¢–ö–ê–ó–ê–¢–¨–°–Ø</button>
                `;
            } else if(!isBusy) {
                html += `<button class="btn btn-main" onclick="takeOrder('${o.id}')">–í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£</button>`;
            }

            if(isMe && !isBusy) {
                html += `<div class="admin-tools"><button class="btn-small" onclick="deleteOrder('${o.id}')">–£–î–ê–õ–ò–¢–¨</button><button class="btn-small" onclick="editOrder('${o.id}')">–ò–ó–ú–ï–ù–ò–¢–¨</button></div>`;
            }
            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    function renderArchive(archived) {
        const container = document.getElementById('archive-list');
        container.innerHTML = archived.length ? '' : '<div style="text-align:center;color:#333;margin-top:50px;">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>';
        archived.forEach(o => {
            const card = document.createElement('div');
            card.className = `card`; card.style.opacity = '0.6';
            card.innerHTML = `
                <div class="card-header"><span class="tag-city">${o.city}</span><span>${o.closedAt}</span></div>
                <div class="badge-status" style="background:rgba(76, 175, 80, 0.2);color:var(--success)">‚úÖ –í–´–ü–û–õ–ù–ï–ù–û</div>
                <h3>${o.task}</h3><div class="addr">üìç ${o.addr}</div>
                <div style="font-size:10px;color:var(--main-gold)">–ú–∞—Å—Ç–µ—Ä: ${o.worker}</div>
            `;
            container.appendChild(card);
        });
    }

    function saveOrder() {
        const editId = document.getElementById('edit-id').value;
        const id = editId || Date.now().toString();
        const task = document.getElementById('task').value.trim();
        const addr = document.getElementById('address').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const city = document.getElementById('city-input').value;
        if(!task || !addr || phone.length < 18) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
        const time = new Date().toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
        db.ref('shabashki/active/' + id).update({
            id, author: MY_ID, task, addr, phone, city, date: time, 
            status: 'free', timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            resetForm();
            changeView('list', document.querySelector('nav button:first-child'));
        });
    }

    function takeOrder(id) { 
        db.ref(`shabashki/active/${id}`).update({ status: 'busy', worker: MY_ID, takenAt: Date.now() }); 
    }

    function finishOrder(id) {
        db.ref(`shabashki/active/${id}`).once('value', snap => {
            const o = snap.val();
            if(!o || (o.takenAt && (Date.now() - o.takenAt < WAIT_TIME))) return alert("–í—Ä–µ–º—è –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–æ!");
            const closedAt = new Date().toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            db.ref('shabashki/archive').push({...o, closedAt, timestamp: firebase.database.ServerValue.TIMESTAMP});
            db.ref(`shabashki/active/${id}`).remove();
        });
    }

    function changeView(view, btn) {
        if(view === 'add' && !document.getElementById('edit-id').value) resetForm();
        document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-' + view).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('city-tabs-ui').style.display = (view === 'list') ? 'flex' : 'none';
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('task').value = '';
        document.getElementById('address').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('save-btn').innerText = '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨';
    }

    function openRej(id) { currentRejId = id; document.getElementById('modal-rej').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-rej').style.display = 'none'; document.getElementById('rej-text').value = ''; }
    
    function submitRejection() {
        const txt = document.getElementById('rej-text').value.trim();
        if(!txt) return alert("–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É");
        db.ref(`shabashki/active/${currentRejId}/rejections`).push({ 
            user: MY_ID, 
            text: txt,
            time: Date.now()
        });
        db.ref(`shabashki/active/${currentRejId}`).update({ 
            status: 'free', 
            worker: null, 
            takenAt: null 
        });
        closeModal();
    }

    function deleteOrder(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) db.ref(`shabashki/active/${id}`).remove(); }
    function editOrder(id) {
        db.ref(`shabashki/active/${id}`).once('value', snap => {
            const o = snap.val();
            document.getElementById('edit-id').value = o.id;
            document.getElementById('task').value = o.task;
            document.getElementById('address').value = o.addr;
            document.getElementById('phone').value = o.phone;
            document.getElementById('city-input').value = o.city;
            document.getElementById('save-btn').innerText = '–°–û–•–†–ê–ù–ò–¢–¨';
            changeView('add', document.querySelectorAll('nav button')[1]);
        });
    }

    initSync();
</script>
</body>
</html>
