<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOLT MASTER - CLOUD –®–ê–ë–ê–®–ö–ò</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        :root {
            --main-gold: #ffc107;
            --dark-bg: #0f0f0f;
            --card-bg: rgba(255, 255, 255, 0.07);
            --text-main: #ffffff;
            --text-dim: #999999;
            --success: #4caf50;
            --process: #2196f3;
            --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; background: var(--dark-bg);
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 100%);
            color: var(--text-main); 
            padding-bottom: 120px; /* –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–æ–≤—É—é –ø–∞–Ω–µ–ª—å */
            min-height: 100vh;
        }

        header { padding: 20px; text-align: center; }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin: 0; }
        .logo span { color: var(--main-gold); }
        .sub-header { font-size: 10px; color: #444; letter-spacing: 3px; margin-top: 5px; text-transform: uppercase; }

        .status-badge {
            display: inline-flex; align-items: center;
            background: rgba(255, 193, 7, 0.08); color: #fff;
            padding: 6px 15px; border-radius: 20px;
            font-size: 11px; margin-top: 10px; border: 1px solid rgba(255, 193, 7, 0.2);
        }

        /* –ö–ê–†–¢–û–ß–ö–ò */
        .card {
            background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px; padding: 18px; margin: 0 15px 12px; position: relative;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .my-order { border-left: 4px solid var(--main-gold); }
        .status-taken { border-color: var(--process); background: rgba(33, 150, 243, 0.05); }

        .badge-status {
            font-size: 9px; padding: 4px 8px; border-radius: 6px; font-weight: bold;
            display: inline-block; margin-bottom: 10px; text-transform: uppercase;
        }
        .bg-free { background: rgba(255,255,255,0.1); color: #fff; }
        .bg-busy { background: rgba(33, 150, 243, 0.2); color: var(--process); }

        .card-header { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 8px; }
        .tag-city { color: var(--main-gold); font-weight: bold; }
        
        h3 { margin: 5px 0; font-size: 17px; }
        .addr { color: var(--text-dim); font-size: 13px; margin-bottom: 12px; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: var(--main-gold); color: #000; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-outline { background: rgba(255,255,255,0.05); color: #fff; margin-top: 8px; border: 1px solid #333; }

        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        nav {
            position: fixed; bottom: 0; width: 100%; 
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; justify-content: space-around; 
            padding: 15px 0 25px 0; /* –ë–æ–ª—å—à–∞—è –≤—ã—Å–æ—Ç–∞ */
            z-index: 1000;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.6);
        }
        nav button { 
            background: none; border: none; color: #555; 
            font-size: 10px; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            flex: 1; transition: 0.3s;
        }
        nav button.active { color: var(--main-gold); }
        nav button i { font-style: normal; font-size: 20px; }

        /* –ú–û–î–ê–õ–ö–ò –ò –§–û–†–ú–´ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal { background: #161616; padding: 25px; border-radius: 20px; width: 85%; border: 1px solid #333; }
        .hidden { display: none; }
        input, select, textarea { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 12px; padding: 14px; color: #fff; width: 100%; margin-bottom: 10px; box-sizing: border-box; font-size: 16px; }
        
        .admin-tools { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        .btn-small { padding: 6px; font-size: 9px; background: #222; color: #777; border-radius: 6px; flex: 1; border: none; }
    </style>
</head>
<body>

<header>
    <div class="logo">VOLT<span>MASTER</span></div>
    <div class="sub-header">CLOUD –®–ê–ë–ê–®–ö–ò</div>
    <div class="status-badge"><span id="my-id-display">ID...</span></div>
</header>

<div id="view-list"><div id="orders-list"></div></div>
<div id="view-archive" class="hidden"><div id="archive-list"></div></div>

<div id="view-add" class="hidden" style="padding: 20px;">
    <h2 style="font-size: 18px; margin-bottom: 20px;">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
    <input type="hidden" id="edit-id">
    <select id="city-input">
        <option value="–ú–∞—Ö–∞—á–∫–∞–ª–∞">–ú–∞—Ö–∞—á–∫–∞–ª–∞</option>
        <option value="–ö–∞—Å–ø–∏–π—Å–∫">–ö–∞—Å–ø–∏–π—Å–∫</option>
        <option value="–ë—É–π–Ω–∞–∫—Å–∫">–ë—É–π–Ω–∞–∫—Å–∫</option>
    </select>
    <input type="text" id="task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞, –¥–æ–º)">
    <input type="tel" id="phone" placeholder="+7 (___) ___-__-__" maxlength="18">
    <button class="btn btn-main" onclick="saveOrder()" id="save-btn" style="margin-top: 10px;">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
</div>

<div id="modal-rej" class="modal-overlay">
    <div class="modal">
        <h3 style="color:var(--main-gold)">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞</h3>
        <textarea id="rej-text" rows="4" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É..."></textarea>
        <button class="btn btn-main" onclick="submitRejection()">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        <button class="btn btn-outline" onclick="closeModal()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<nav>
    <button onclick="changeView('list', this)" class="active"><i>üìã</i>–ó–ê–ö–ê–ó–´</button>
    <button onclick="changeView('add', this)"><i>‚ûï</i>–°–û–ó–î–ê–¢–¨</button>
    <button onclick="changeView('archive', this)"><i>üìÅ</i>–ê–†–•–ò–í</button>
</nav>

<script>
    const firebaseConfig = { databaseURL: "https://kalculator-8e345-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MY_ID = localStorage.getItem('user_id_2026') || "USER-" + Math.floor(Math.random()*9000);
    localStorage.setItem('user_id_2026', MY_ID);
    document.getElementById('my-id-display').innerText = "–í–ê–® ID: " + MY_ID;

    // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    document.getElementById('phone').addEventListener('input', (e) => {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
        if (!x[2]) { e.target.value = x[1] ? '+7 (' : ''; }
        else { e.target.value = '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : ''); }
    });

    let currentRejId = null;

    function initSync() {
        db.ref('shabashki/active').on('value', snap => {
            const data = snap.val() || {};
            render(Object.values(data).sort((a,b) => b.id - a.id));
        });
        db.ref('shabashki/archive').limitToLast(20).on('value', snap => {
            const data = snap.val() || {};
            renderArchive(Object.values(data).sort((a,b) => b.timestamp - a.timestamp));
        });
    }

    function render(orders) {
        const container = document.getElementById('orders-list');
        container.innerHTML = orders.length ? '' : '<div style="text-align:center;color:#444;margin-top:50px;">–°–≤–æ–±–æ–¥–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</div>';
        
        orders.forEach(o => {
            const isMe = o.author === MY_ID;
            const isBusy = o.status === 'busy';
            const card = document.createElement('div');
            card.className = `card ${isMe ? 'my-order' : ''} ${isBusy ? 'status-taken' : ''}`;
            
            let html = `
                <div class="card-header"><span class="tag-city">${o.city}</span><span style="color:#555">${o.date}</span></div>
                <span class="badge-status ${isBusy ? 'bg-busy' : 'bg-free'}">${isBusy ? '‚è≥ –í —Ä–∞–±–æ—Ç–µ —É: '+o.worker : 'üîò –°–≤–æ–±–æ–¥–µ–Ω'}</span>
                <h3>${o.task}</h3><div class="addr">üìç ${o.addr}</div>
            `;

            if(isBusy && o.worker === MY_ID) {
                html += `
                    <div style="background:rgba(255,193,7,0.1); padding:15px; border-radius:12px; text-align:center; margin-bottom:12px; border: 1px solid rgba(255,193,7,0.2);">
                        <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">–°–í–Ø–ó–¨ –° –ö–õ–ò–ï–ù–¢–û–ú</div>
                        <a href="tel:${o.phone}" style="color:var(--main-gold); text-decoration:none; font-weight:800; font-size:20px;">${o.phone}</a>
                    </div>
                    <button class="btn btn-success" onclick="finishOrder('${o.id}')">–ó–ê–í–ï–†–®–ò–¢–¨ –û–ë–™–ï–ö–¢</button>
                    <button class="btn btn-outline" onclick="openRej('${o.id}')">–û–¢–ö–ê–ó–ê–¢–¨–°–Ø</button>
                `;
            } else if(!isBusy) {
                html += `<button class="btn btn-main" onclick="takeOrder('${o.id}')">–í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£</button>`;
            }

            if(isMe && !isBusy) {
                html += `<div class="admin-tools"><button class="btn-small" onclick="deleteOrder('${o.id}')">–£–î–ê–õ–ò–¢–¨</button><button class="btn-small" onclick="editOrder('${o.id}')">–ò–ó–ú–ï–ù–ò–¢–¨</button></div>`;
            }
            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    function renderArchive(archived) {
        const container = document.getElementById('archive-list');
        container.innerHTML = archived.length ? '' : '<div style="text-align:center;color:#333;margin-top:50px;">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>';
        archived.forEach(o => {
            const card = document.createElement('div');
            card.className = `card`; card.style.opacity = '0.6';
            card.innerHTML = `
                <div class="card-header"><span class="tag-city">${o.city}</span><span>${o.closedAt}</span></div>
                <div class="badge-status" style="background:rgba(76, 175, 80, 0.2);color:var(--success)">‚úÖ –í–´–ü–û–õ–ù–ï–ù–û</div>
                <h3>${o.task}</h3><div class="addr">üìç ${o.addr}</div>
                <div style="font-size:10px;color:var(--main-gold)">–ú–∞—Å—Ç–µ—Ä: ${o.worker}</div>
            `;
            container.appendChild(card);
        });
    }

    function saveOrder() {
        const id = document.getElementById('edit-id').value || Date.now().toString();
        const task = document.getElementById('task').value;
        const addr = document.getElementById('address').value;
        const phone = document.getElementById('phone').value;
        const city = document.getElementById('city-input').value;
        if(!task || !addr || phone.length < 18) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!");

        const time = new Date().toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
        
        db.ref('shabashki/active/' + id).update({
            id, author: MY_ID, task, addr, phone, city, date: time, status: 'free'
        }).then(() => {
            document.getElementById('edit-id').value = '';
            document.getElementById('task').value = '';
            document.getElementById('address').value = '';
            document.getElementById('phone').value = '';
            changeView('list', document.querySelector('nav button:first-child'));
        });
    }

    function takeOrder(id) { db.ref(`shabashki/active/${id}`).update({ status: 'busy', worker: MY_ID }); }

    function finishOrder(id) {
        db.ref(`shabashki/active/${id}`).once('value', snap => {
            const o = snap.val();
            const closedAt = new Date().toLocaleString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            db.ref('shabashki/archive').push({...o, closedAt, timestamp: firebase.database.ServerValue.TIMESTAMP});
            db.ref(`shabashki/active/${id}`).remove();
        });
    }

    function changeView(view, btn) {
        document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('view-' + view).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        window.scrollTo(0,0);
    }

    function openRej(id) { currentRejId = id; document.getElementById('modal-rej').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-rej').style.display = 'none'; }
    function submitRejection() {
        const txt = document.getElementById('rej-text').value;
        if(!txt) return alert("–ü—Ä–∏—á–∏–Ω–∞?");
        db.ref(`shabashki/active/${currentRejId}/rejections`).push({ user: MY_ID, text: txt });
        db.ref(`shabashki/active/${currentRejId}`).update({ status: 'free', worker: null });
        closeModal();
    }
    function deleteOrder(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?")) db.ref(`shabashki/active/${id}`).remove(); }
    function editOrder(id) {
        db.ref(`shabashki/active/${id}`).once('value', snap => {
            const o = snap.val();
            document.getElementById('edit-id').value = o.id;
            document.getElementById('task').value = o.task;
            document.getElementById('address').value = o.addr;
            document.getElementById('phone').value = o.phone;
            document.getElementById('city-input').value = o.city;
            changeView('add', document.querySelectorAll('nav button')[1]);
        });
    }

    initSync();
</script>
</body>
</html>
