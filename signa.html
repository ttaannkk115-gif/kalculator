<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOLT MASTER Pro</title>
    <style>
        :root {
            --primary: #00a884;
            --bg: #111b21;
            --chat-bg: #0b141a;
            --my-msg: #005c4b;
            --others-msg: #202c33;
            --ticks-blue: #53bdeb;
            --notify: #25d366;
            --text-main: #e9edef;
            --accent: #ffc107;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, sans-serif; overflow: hidden; background: var(--bg); color: var(--text-main); }
        #app-container { display: flex; width: 200%; height: 100%; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body.in-chat #app-container { transform: translateX(-50%); }

        #contact-screen { width: 50%; height: 100%; background: var(--bg); display: flex; flex-direction: column; border-right: 1px solid #222; }
        .header { padding: 15px; background: #202c33; }
        #userList { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #userList li { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        .unread-badge { background: var(--notify); color: #000; font-size: 11px; font-weight: bold; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 6px; }
        .remove-chat { color: #8696a0; font-size: 18px; padding: 5px; cursor: pointer; margin-left: 10px; }

        #chat-screen { width: 50%; height: 100%; background: var(--chat-bg); display: flex; flex-direction: column; position: relative; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; }
        
        .chat-header { background: #202c33; padding: 10px 15px; display: flex; align-items: center; gap: 12px; z-index: 10; height: 60px; }
        .back-btn { background: none; border: none; color: var(--primary); font-size: 24px; cursor: pointer; }

        .msg { max-width: 80%; padding: 8px 10px; border-radius: 8px; font-size: 14.5px; position: relative; cursor: pointer; }
        .msg.my { align-self: flex-end; background: var(--my-msg); border-top-right-radius: 0; }
        .msg.others { align-self: flex-start; background: var(--others-msg); border-top-left-radius: 0; }
        
        .sender-info { font-size: 11px; font-weight: bold; color: var(--accent); margin-bottom: 4px; cursor: pointer; }
        .msg-reply-quote { background: rgba(0,0,0,0.2); border-left: 3px solid var(--primary); padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 12px; }
        .msg-footer { font-size: 10px; color: #8696a0; text-align: right; margin-top: 3px; display: flex; justify-content: flex-end; gap: 3px; }

        #reply-bar { display: none; background: #1c272d; padding: 10px; border-left: 4px solid var(--primary); margin: 0 10px; border-radius: 5px 5px 0 0; position: relative; }
        .input-panel { background: #202c33; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .input-panel input { flex: 1; border: none; padding: 12px 15px; border-radius: 25px; background: #2a3942; color: white; outline: none; }

        @keyframes highlight { 0% { background: #3b4a54; } 100% { background: inherit; } }
        .highlight-target { animation: highlight 2s ease; }

        @media (min-width: 768px) { #app-container { width: 100%; transform: none !important; } #contact-screen { width: 350px; } #chat-screen { width: calc(100% - 350px); } .back-btn { display: none; } }
    </style>
</head>
<body>

<div id="app-container">
    <div id="contact-screen">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="myIdDisplay" style="font-size:11px; color:var(--primary)"></span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer; font-size:12px;" onclick="tryAdmin()">ADMIN</span>
            </div>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID..." style="width:100%; padding:10px; border-radius:20px; border:none; background:#2a3942; color:white; outline:none;" onkeypress="if(event.key === 'Enter') searchUser()">
        </div>
        <ul id="userList"></ul>
    </div>

    <div id="chat-screen">
        <div class="chat-header">
            <button class="back-btn" onclick="closeChat()">‚ùÆ</button>
            <div id="chatTitle" style="font-weight:bold;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <button id="adminDelBtn" style="background:none; border:none; display:none; margin-left:auto; font-size:18px;" onclick="clearHistory()">üóëÔ∏è</button>
        </div>
        <div id="messages"></div>
        <div id="reply-bar">
            <div onclick="cancelReply()" style="position:absolute; right:10px; top:5px; cursor:pointer; color:#8696a0;">‚úï</div>
            <div id="reply-user" style="font-size:12px; color:var(--primary); font-weight:bold;"></div>
            <div id="reply-text" style="font-size:13px; opacity:0.7; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></div>
        </div>
        <div class="input-panel">
            <input type="text" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key === 'Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:none; border:none; color:var(--primary); font-size:22px;">‚û§</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, onDisconnect, serverTimestamp, update, get, child, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://kalculator-8e345-default-rtdb.firebaseio.com/" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let myId = localStorage.getItem('user_id_2026') || "ID-" + Math.floor(1000 + Math.random() * 9000);
    localStorage.setItem('user_id_2026', myId);
    let myName = localStorage.getItem('chat_user_name') || prompt("–ò–º—è:") || myId;
    localStorage.setItem('chat_user_name', myName);

    let currentChatId = null, isGlobal = false, replyingTo = null;
    let recentUsers = JSON.parse(localStorage.getItem('recent_chats') || "[]");
    let namesCache = {}, unreadCounts = {}, globalUnread = 0;
    
    // –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –≤–∏–¥–µ–ª–∏ –≤ –æ–±—â–µ–º —á–∞—Ç–µ
    let lastSeenGlobalTs = parseInt(localStorage.getItem('last_msg_global_ts') || "0");
    let tempLastTs = 0; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∞–º–æ–≥–æ —Å–≤–µ–∂–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º —á–∞—Ç–µ

    const statusRef = ref(db, 'status/' + myId);
    set(statusRef, { online: true, name: myName });
    onDisconnect(statusRef).update({ online: false });

    onValue(ref(db, 'status'), (snap) => {
        snap.forEach(s => { namesCache[s.key] = s.val().name; });
        renderList();
    });

    onValue(ref(db, 'global_messages'), (snap) => {
        let count = 0;
        let maxTs = lastSeenGlobalTs;
        snap.forEach(m => {
            const ts = m.val().ts || 0;
            if (m.val().sender !== myId && ts > lastSeenGlobalTs) count++;
            if (ts > maxTs) maxTs = ts;
        });
        globalUnread = count;
        if (isGlobal) tempLastTs = maxTs; // –ï—Å–ª–∏ —á–∞—Ç –æ—Ç–∫—Ä—ã—Ç, –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –º–∞–∫—Å–∏–º—É–º
        renderList();
    });

    onValue(ref(db, 'private_messages'), (snap) => {
        unreadCounts = {};
        snap.forEach(chat => {
            if (chat.key.includes(myId)) {
                const otherId = chat.key.replace(myId, "").replace("_", "");
                let count = 0;
                chat.forEach(m => { if (m.val().sender !== myId && m.val().status !== 'read') count++; });
                if (count > 0) unreadCounts[otherId] = count;
            }
        });
        renderList();
    });

    function renderList() {
        const list = document.getElementById('userList');
        list.innerHTML = `
            <li onclick="openChat('GLOBAL_CHAT', true)" style="background:rgba(0,168,132,0.05)">
                <b>üì¢ –û–ë–©–ò–ô –ß–ê–¢</b>
                ${globalUnread > 0 ? `<div class="unread-badge">${globalUnread}</div>` : ''}
            </li>`;
        recentUsers.forEach(uId => {
            if (uId === myId) return;
            list.innerHTML += `
                <li onclick="openChat('${uId}', false)">
                    <div><b>${namesCache[uId] || uId}</b><br><small>${uId}</small></div>
                    <div style="display:flex; align-items:center;">
                        ${unreadCounts[uId] ? `<div class="unread-badge">${unreadCounts[uId]}</div>` : ''}
                        <div class="remove-chat" onclick="event.stopPropagation(); removeRecent('${uId}')">‚úï</div>
                    </div>
                </li>`;
        });
        document.getElementById('myIdDisplay').innerText = `–í—ã: ${myName} (${myId})`;
    }

    window.openChat = (targetId, global) => {
        isGlobal = global;
        if (isGlobal) { globalUnread = 0; renderList(); }
        else if (!recentUsers.includes(targetId)) {
            recentUsers.unshift(targetId);
            localStorage.setItem('recent_chats', JSON.stringify(recentUsers));
        }
        currentChatId = isGlobal ? 'GLOBAL_CHAT' : [myId, targetId].sort().join("_");
        document.getElementById('chatTitle').innerText = isGlobal ? "–û–±—â–∏–π —á–∞—Ç" : (namesCache[targetId] || targetId);
        document.body.classList.add('in-chat');

        const path = isGlobal ? 'global_messages' : 'private_messages/' + currentChatId;
        onValue(ref(db, path), (snap) => {
            const box = document.getElementById('messages'); box.innerHTML = "";
            snap.forEach(m => {
                const d = m.val();
                if (isGlobal && (d.ts || 0) > tempLastTs) tempLastTs = d.ts; // –û–±–Ω–æ–≤–ª—è–µ–º "–≤–∏–¥–µ–Ω–Ω–æ–µ" –≤—Ä–µ–º—è
                if (!isGlobal && d.sender !== myId && d.status !== 'read') update(ref(db, path + '/' + m.key), { status: 'read' });
                
                const div = document.createElement('div');
                div.className = `msg ${d.sender === myId ? 'my' : 'others'}`;
                div.id = "msg-" + m.key;
                div.onclick = () => selectReply(m.key, namesCache[d.sender] || d.sender, d.text);
                div.ondblclick = (e) => { e.stopPropagation(); if(d.sender === myId) editMessage(m.key, d.text); };

                let senderTag = (isGlobal && d.sender !== myId) ? `<div class="sender-info" onclick="event.stopPropagation(); openChat('${d.sender}', false)">${namesCache[d.sender] || 'User'} (${d.sender})</div>` : "";
                let reply = d.replyTo ? `<div class="msg-reply-quote" onclick="event.stopPropagation(); scrollToMsg('msg-${d.replyTo.id}')"><b>${d.replyTo.name}</b><br>${d.replyTo.text}</div>` : "";
                let ticks = (d.sender === myId && !isGlobal) ? `<span style="color:${d.status==='read'?'var(--ticks-blue)':'#8696a0'}">‚úì‚úì</span>` : "";

                div.innerHTML = `${senderTag}${reply}<span>${d.text}</span><div class="msg-footer">${new Date(d.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} ${ticks}</div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.closeChat = () => { 
        if (isGlobal) {
            lastSeenGlobalTs = tempLastTs;
            localStorage.setItem('last_msg_global_ts', lastSeenGlobalTs);
            globalUnread = 0;
        }
        document.body.classList.remove('in-chat'); 
        cancelReply(); 
        renderList();
    };

    window.removeRecent = (uId) => {
        recentUsers = recentUsers.filter(id => id !== uId);
        localStorage.setItem('recent_chats', JSON.stringify(recentUsers));
        renderList();
    };

    window.scrollToMsg = (id) => {
        const el = document.getElementById(id);
        if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.classList.add('highlight-target'); setTimeout(() => el.classList.remove('highlight-target'), 2000); }
    };

    window.selectReply = (id, name, text) => {
        replyingTo = { id, name, text };
        document.getElementById('reply-bar').style.display = 'block';
        document.getElementById('reply-user').innerText = name;
        document.getElementById('reply-text').innerText = text;
        document.getElementById('msgInput').focus();
    };

    window.editMessage = (id, oldText) => {
        const newText = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:", oldText);
        if (newText && newText !== oldText) update(ref(db, (isGlobal ? 'global_messages/' : `private_messages/${currentChatId}/`) + id), { text: newText + " (–∏–∑–º.)" });
    };

    window.sendMessage = () => {
        const i = document.getElementById('msgInput'); if (!i.value.trim()) return;
        const data = { sender: myId, text: i.value, ts: serverTimestamp(), status: 'sent' };
        if (replyingTo) { data.replyTo = { id: replyingTo.id, name: replyingTo.name, text: replyingTo.text }; cancelReply(); }
        push(ref(db, isGlobal ? 'global_messages' : 'private_messages/' + currentChatId), data);
        i.value = "";
    };

    window.cancelReply = () => { replyingTo = null; document.getElementById('reply-bar').style.display = 'none'; };
    window.tryAdmin = () => { if (prompt("Pass:") === '6739218') document.getElementById('adminDelBtn').style.display = 'block'; };
    window.clearHistory = () => { if (confirm("–û—á–∏—Å—Ç–∏—Ç—å?")) remove(ref(db, isGlobal ? 'global_messages' : 'private_messages/' + currentChatId)); };
    window.searchUser = async () => {
        const q = document.getElementById('searchInput').value.trim();
        const s = await get(child(ref(db), `status/${q}`));
        if (s.exists()) openChat(q, false); else alert("ID –Ω–µ –Ω–∞–π–¥–µ–Ω");
    };

    setInterval(() => localStorage.setItem('volt_master_backup', document.documentElement.outerHTML), 10000);
</script>
</body>
</html>
