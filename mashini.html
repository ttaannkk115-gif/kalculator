<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–≠–≤–∞–∫—É–∞—Ç–æ—Ä: –£–õ–¨–¢–†–ê –ö–û–ú–ë–û</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #111; 
            font-family: 'Arial Black', sans-serif; touch-action: none; 
            user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; touch-action: none; }
        #ui {
            position: absolute; top: 15px; left: 15px; color: white; pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); z-index: 5;
        }
        #combo-container {
            position: absolute; top: 85px; left: 15px; width: 140px; display: none;
        }
        #combo-text { color: #ffeb3b; font-size: 26px; font-style: italic; margin-bottom: 5px; }
        #combo-bar-bg { width: 100%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; }
        #combo-bar-fill { width: 100%; height: 100%; background: #ffeb3b; }
        
        #restart-menu {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); color: white; padding: 30px; border-radius: 20px;
            text-align: center; display: none; z-index: 10; border: 3px solid #ff4444; width: 80%;
        }
        button {
            background: #ff4444; color: white; border: none; padding: 18px 35px; font-size: 20px;
            font-weight: bold; border-radius: 12px; cursor: pointer; margin-top: 15px;
        }
        .bonus-anim {
            position: absolute; font-weight: bold; pointer-events: none; 
            animation: flyUp 0.6s ease-out forwards; text-shadow: 2px 2px 0px black;
            z-index: 100;
        }
        @keyframes flyUp { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translateY(-130px) scale(1.4); } }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-size: 30px; color: #fff;">–°–ß–ï–¢: <span id="score">0</span></div>
    <div style="font-size: 14px; color: #888;">–†–ï–ö–û–†–î –ú–ê–°–¢–ï–†–ê: <span id="high-score">0</span></div>
</div>

<div id="combo-container">
    <div id="combo-text">X2 COMBO</div>
    <div id="combo-bar-bg"><div id="combo-bar-fill"></div></div>
</div>

<div id="restart-menu">
    <h2 style="margin: 0; color: #ff4444;">üí• –ö–†–ê–®!</h2>
    <p id="final-score" style="font-size: 24px; margin: 15px 0;"></p>
    <button onclick="resetGame()">–í–ï–†–ù–£–¢–¨–°–Ø –ù–ê –¢–†–ê–°–°–£</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const highEl = document.getElementById('high-score');
    const menu = document.getElementById('restart-menu');
    const comboContainer = document.getElementById('combo-container');
    const comboText = document.getElementById('combo-text');
    const comboFill = document.getElementById('combo-bar-fill');

    let score = 0;
    let highScore = localStorage.getItem('towTruckFastCombo') || 0;
    highEl.innerText = highScore;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    let gameActive = true;
    let isCrashed = false;
    let comboMultiplier = 1;
    let comboTimer = 0;
    const BASE_COMBO_TIME = 80;

    const player = {
        w: 52, h: 105,
        x: 0, y: 0,
        targetX: 0, targetY: 0
    };

    // –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
    player.x = canvas.width / 2 - player.w / 2;
    player.y = canvas.height - 200;
    player.targetX = player.x;
    player.targetY = player.y;

    let obstacles = [];
    let roadY = 0;

    function drawCar(x, y, w, h, color, isPlayer) {
        ctx.save();
        if (isPlayer && comboMultiplier > 1) {
            ctx.shadowBlur = 15;
            ctx.shadowColor = comboMultiplier > 5 ? "#ff4444" : "#ffeb3b";
        }
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.rect(x, y, w, h);
        ctx.fill();
        // –û–∫–Ω–∞
        ctx.fillStyle = '#111';
        ctx.fillRect(x + 10, y + 15, w - 20, 25); 
        ctx.fillRect(x + 10, y + 70, w - 20, 15);
        // –§–∞—Ä—ã
        ctx.fillStyle = isPlayer ? '#fff' : '#ffee58';
        ctx.fillRect(x + 6, y + 2, 10, 5);
        ctx.fillRect(x + w - 16, y + 2, 10, 5);
        ctx.restore();
    }

    function spawn() {
        if (!gameActive || isCrashed) return;
        obstacles.push({
            x: Math.random() * (canvas.width - 50),
            y: -120,
            w: 48, h: 95,
            color: ['#2980b9', '#27ae60', '#8e44ad', '#f39c12'][Math.floor(Math.random()*4)],
            speed: 6 + Math.random() * 6 + (score / 1500),
            bonus: false
        });
        
        let nextSpawn = Math.max(200, 700 - score/40);
        setTimeout(spawn, nextSpawn);
    }

    function update() {
        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –î–æ—Ä–æ–≥–∞
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        roadY += (isCrashed ? 0 : 15);
        if (roadY > 100) roadY = 0;
        for (let i = -100; i < canvas.height; i += 100) {
            ctx.fillRect(canvas.width/2 - 2, i + roadY, 4, 50);
        }

        if (comboTimer > 0 && !isCrashed) {
            comboTimer -= (0.5 + comboMultiplier * 0.02);
            comboContainer.style.display = 'block';
            comboFill.style.width = (comboTimer / BASE_COMBO_TIME * 100) + '%';
            comboText.innerText = `X${comboMultiplier} COMBO`;
        } else {
            comboMultiplier = 1;
            comboContainer.style.display = 'none';
        }

        if (!isCrashed) {
            // –ü–ª–∞–≤–Ω–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞ —Ü–µ–ª—å—é
            player.x += (player.targetX - player.x) * 0.2;
            player.y += (player.targetY - player.y) * 0.2;
        }

        drawCar(player.x, player.y, player.w, player.h, '#e74c3c', true);

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            if (!isCrashed) obs.y += obs.speed;
            drawCar(obs.x, obs.y, obs.w, obs.h, obs.color, false);

            // –õ–æ–≥–∏–∫–∞ –∫–æ–º–±–æ (–±–ª–∏–∑–∫–∏–π –ø—Ä–æ–µ–∑–¥ –±–µ–∑ –∞–≤–∞—Ä–∏–∏)
            let dx = Math.abs((player.x + player.w/2) - (obs.x + obs.w/2));
            let dy = Math.abs((player.y + player.h/2) - (obs.y + obs.h/2));
            
            if (!obs.bonus && !isCrashed && dx < 70 && dx > 40 && dy < 60) {
                comboMultiplier++;
                comboTimer = BASE_COMBO_TIME;
                let pts = 50 * comboMultiplier;
                score += pts;
                obs.bonus = true;
                showBonusText(player.x, player.y, pts, comboMultiplier);
                scoreEl.innerText = score;
            }

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ
            if (player.x < obs.x + obs.w - 8 && player.x + player.w > obs.x + 8 &&
                player.y < obs.y + obs.h - 8 && player.y + player.h > obs.y + 8) {
                isCrashed = true;
                gameActive = false;
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('towTruckFastCombo', score);
                    highEl.innerText = highScore;
                }
                setTimeout(() => {
                    document.getElementById('final-score').innerText = `–°–ß–ï–¢: ${score}`;
                    menu.style.display = 'block';
                }, 500);
            }

            if (obs.y > canvas.height + 100) {
                obstacles.splice(i, 1);
            }
        }
        requestAnimationFrame(update);
    }

    function showBonusText(x, y, pts, multi) {
        const b = document.createElement('div');
        b.className = 'bonus-anim';
        b.style.left = x + 'px'; b.style.top = y + 'px';
        b.style.color = multi > 5 ? '#ff4444' : '#ffeb3b';
        b.innerHTML = `+${pts}<br>X${multi}`;
        document.body.appendChild(b);
        setTimeout(() => b.remove(), 600);
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï
    function handleMove(e) {
        if (isCrashed || !gameActive) return;

        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        const rect = canvas.getBoundingClientRect();
        
        // –ú–∞—à–∏–Ω–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∫—É—Ä—Å–æ—Ä–æ–º/–ø–∞–ª—å—Ü–µ–º
        let nextX = clientX - rect.left - player.w / 2;
        let nextY = clientY - rect.top - player.h / 2 - 80; // –°–º–µ—â–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö

        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ —É—Ö–æ–¥–∏–ª–∞ –∑–∞ –∫—Ä–∞—è)
        player.targetX = Math.max(0, Math.min(canvas.width - player.w, nextX));
        player.targetY = Math.max(0, Math.min(canvas.height - player.h, nextY));

        if (e.cancelable) e.preventDefault();
    }

    canvas.addEventListener('touchstart', handleMove, { passive: false });
    canvas.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('mousemove', handleMove);

    function resetGame() {
        score = 0;
        scoreEl.innerText = '0';
        obstacles = [];
        isCrashed = false;
        gameActive = true;
        comboMultiplier = 1;
        comboTimer = 0;
        menu.style.display = 'none';
        
        player.x = canvas.width / 2 - player.w / 2;
        player.y = canvas.height - 200;
        player.targetX = player.x;
        player.targetY = player.y;

        spawn();
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç
    window.onload = () => {
        window.focus();
        spawn();
        update();
    };
</script>
</body>
</html>
