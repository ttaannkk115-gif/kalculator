<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOLT MASTER Panel</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffc107">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/355/355980.png">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        :root {
            --main-gold: #ffc107;
            --chat-blue: #2196f3;
            --break-green: #4caf50;
            --note-purple: #9c27b0;
            --shabash-orange: #ff9800;
            --dark-bg: #0f0f0f;
            --card-bg: rgba(255, 255, 255, 0.07);
            --text-main: #ffffff;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-bg);
            color: var(--text-main);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 100%);
            overflow: hidden;
        }

        .app-container { width: 90%; max-width: 380px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .header { text-align: center; margin-bottom: 25px; cursor: pointer; user-select: none; }
        .header h1 { font-size: 26px; font-weight: 800; margin: 0; letter-spacing: 1px; }
        .header span { color: var(--main-gold); }

        .status-badge {
            display: inline-flex; align-items: center;
            background: rgba(255, 193, 7, 0.08);
            color: #fff; padding: 6px 18px; border-radius: 20px;
            font-size: 11px; margin-top: 8px;
            border: 1px solid rgba(255, 193, 7, 0.2);
            min-width: 180px; justify-content: center; gap: 8px;
            font-family: monospace;
        }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        .menu-grid { display: grid; gap: 12px; }
        .menu-item {
            background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px; padding: 18px; display: flex; align-items: center;
            cursor: pointer; transition: var(--transition);
        }
        .menu-item:hover { background: rgba(255, 255, 255, 0.12); border-color: var(--main-gold); transform: translateY(-3px); }

        .icon-box { width: 48px; height: 48px; border-radius: 14px; display: flex; justify-content: center; align-items: center; margin-right: 16px; flex-shrink: 0; font-size: 20px; }
        .icon-price { background: rgba(255, 193, 7, 0.15); color: var(--main-gold); }
        .icon-shabash { background: rgba(255, 152, 0, 0.15); color: var(--shabash-orange); }
        .icon-calc { background: rgba(255, 152, 0, 0.15); color: #ff9800; }
        .icon-note { background: rgba(156, 39, 176, 0.15); color: var(--note-purple); }
        .icon-chat { background: rgba(33, 150, 243, 0.15); color: var(--chat-blue); }
        .icon-break { background: rgba(76, 175, 80, 0.15); color: var(--break-green); }

        .counter-badge {
            display: none; justify-content: center; align-items: center;
            font-size: 11px; font-weight: 900; min-width: 18px; height: 18px;
            padding: 0 5px; border-radius: 10px; margin-left: auto;
        }
        #shabash-counter { background: var(--shabash-orange); color: #000; }
        #chat-counter { background: var(--chat-blue); color: #fff; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 2000; display: none; flex-direction: column; }
        .overlay-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #161616; border-bottom: 1px solid #333; }
        .overlay-body { flex-grow: 1; position: relative; overflow: hidden; }
        iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .close-btn { background: none; border: none; color: #ff4444; font-size: 30px; cursor: pointer; }

        /* Admin Styles */
        .admin-controls { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .admin-input-group { display: flex; gap: 8px; margin: 10px 0; }
        .admin-input { flex: 1; background: #000; border: 1px solid #333; border-radius: 8px; color: #fff; padding: 10px; }
        .admin-add-btn { background: var(--main-gold); border: none; width: 45px; border-radius: 8px; font-weight: bold; }
        .tag { background: rgba(255,255,255,0.05); border: 1px solid #444; color: #ff4444; padding: 5px 10px; border-radius: 6px; font-size: 12px; display: inline-flex; align-items: center; gap: 5px; margin: 2px; }
        .log-item { padding: 10px 0; border-bottom: 1px solid #222; font-size: 13px; }
        .footer { text-align: center; margin-top: 30px; font-size: 10px; color: #444; letter-spacing: 2px; }

        .whatsapp-float { position: fixed; width: 50px; height: 50px; bottom: 20px; right: 20px; background: #25d366; border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .whatsapp-float img { width: 30px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header" id="main-logo">
        <h1>VOLT<span>MASTER</span></h1>
        <div class="status-badge">
            <div class="status-dot" id="online-dot" style="background: #444;"></div>
            <span id="stats-display">–ó–ê–ì–†–£–ó–ö–ê...</span>
        </div>
    </div>

    <div class="menu-grid">
        <div class="menu-item" onclick="openApp('–ü—Ä–∞–π—Å-–ª–∏—Å—Ç', 'prais.html')">
            <div class="icon-box icon-price">üí∏</div>
            <div class="info"><h3>–ü—Ä–∞–π—Å-–ª–∏—Å—Ç</h3></div>
        </div>
        
        <div class="menu-item" onclick="openApp('–®–∞–±–∞—à–∫–∏', 'shabashki.html')">
            <div class="icon-box icon-shabash">üõ†</div>
            <div class="info" style="display:flex; align-items:center; flex-grow:1;">
                <h3 style="margin:0">–®–∞–±–∞—à–∫–∏</h3>
                <span id="shabash-counter" class="counter-badge">0</span>
            </div>
        </div>

        <div class="menu-item" onclick="openApp('–†–∞—Å—á–µ—Ç—ã', 'izmerenie.html')">
            <div class="icon-box icon-calc">‚ö°</div>
            <div class="info"><h3>–†–∞—Å—á–µ—Ç—ã</h3></div>
        </div>

        <div class="menu-item" onclick="openApp('–ó–∞–º–µ—Ç–∫–∏', 'zametka.html')">
            <div class="icon-box icon-note">üìù</div>
            <div class="info"><h3>–ó–∞–º–µ—Ç–∫–∏</h3></div>
        </div>

        <div class="menu-item" onclick="openApp('–ß–∞—Ç', 'signa.html')">
            <div class="icon-box icon-chat">üí¨</div>
            <div class="info" style="display:flex; align-items:center; flex-grow:1;">
                <h3 style="margin:0">–ß–∞—Ç</h3>
                <span id="chat-counter" class="counter-badge">0</span>
            </div>
        </div>

        <div class="menu-item" onclick="openApp('–ü–µ—Ä–µ–∫—É—Ä', 'igri.html')">
            <div class="icon-box icon-break">‚òï</div>
            <div class="info"><h3>–ü–µ—Ä–µ–∫—É—Ä</h3></div>
        </div>
    </div>
    <div class="footer">VOLT MASTER CLOUD 2026</div>
</div>

<div id="app-overlay" class="overlay">
    <div class="overlay-header">
        <span id="overlay-title" style="color:var(--main-gold);">App</span>
        <button class="close-btn" onclick="closeApp()">&times;</button>
    </div>
    <div class="overlay-body"><iframe id="app-frame"></iframe></div>
</div>

<div id="admin-overlay" class="overlay">
    <div class="overlay-header">
        <span style="color:var(--main-gold); font-weight:bold;">ADMIN PANEL</span>
        <button class="close-btn" onclick="closeAdmin()">&times;</button>
    </div>
    <div class="overlay-body" style="padding: 15px; overflow-y: auto; background: #0a0a0a;">
        <div class="admin-controls">
            <div style="color:var(--main-gold); font-weight:bold; margin-bottom:10px;">–°–ï–ì–û–î–ù–Ø: <span id="today-count">0</span></div>
            <div class="admin-input-group">
                <input type="text" id="exclude-input" class="admin-input" placeholder="–ò—Å–∫–ª—é—á–∏—Ç—å ID">
                <button class="admin-add-btn" onclick="addExclusion()">+</button>
            </div>
            <div id="excluded-tags"></div>
            <button style="background:#ff4444; color:white; border:none; padding:10px; width:100%; border-radius:8px; margin-top:10px;" onclick="clearLogs()">–û–ß–ò–°–¢–ò–¢–¨ –õ–û–ì–ò</button>
        </div>
        <div id="log-container"></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://kalculator-8e345-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let myId = localStorage.getItem('user_id_2026') || "ID-" + Math.floor(Math.random() * 1000);
    localStorage.setItem('user_id_2026', myId);
    let lastShabashCount = -1;
    let excludedIds = [];

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }

    async function initTracker() {
        const statsEl = document.getElementById('stats-display');
        const dot = document.getElementById('online-dot');
        const dateKey = new Date().toISOString().split('T')[0];
        const timeString = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

        database.ref('excluded_list').on('value', snap => {
            excludedIds = Object.values(snap.val() || {});
            renderExclusionTags();
            if (!excludedIds.includes(myId)) {
                database.ref(`registered_users/${myId}`).set({ last_seen: firebase.database.ServerValue.TIMESTAMP });
                database.ref(`visits/${dateKey}/${myId}`).transaction(curr => {
                    if (curr) return { ...curr, count: (curr.count || 1) + 1, time: timeString };
                    return { userId: myId, time: timeString, count: 1, timestamp: firebase.database.ServerValue.TIMESTAMP };
                });
            }
        });

        database.ref('registered_users').on('value', snap => {
            statsEl.innerHTML = `<span style="color:var(--main-gold)">${myId}</span> | –í–°–ï–ì–û: ${snap.numChildren()}`;
        });

        database.ref(".info/connected").on("value", snap => {
            dot.style.background = snap.val() ? "var(--main-gold)" : "#ff4444";
        });

        initCounters();
    }

    function initCounters() {
        database.ref('shabashki/active').on('value', snap => {
            const count = snap.numChildren();
            const el = document.getElementById('shabash-counter');
            if (lastShabashCount !== -1 && count > lastShabashCount && Notification.permission === 'granted') {
                new Notification("VOLT MASTER", { body: "–ù–æ–≤–∞—è —à–∞–±–∞—à–∫–∞!" });
            }
            lastShabashCount = count;
            el.innerText = count;
            el.style.display = count > 0 ? 'inline-flex' : 'none';
        });

        database.ref().on('value', snap => {
            const data = snap.val();
            let unread = 0;
            const lastTs = parseInt(localStorage.getItem('last_msg_global_ts') || "0");
            if (data?.global_messages) Object.values(data.global_messages).forEach(m => { if (m.sender !== myId && (m.ts || 0) > lastTs) unread++; });
            if (data?.private_messages) Object.keys(data.private_messages).forEach(k => {
                if (k.includes(myId)) Object.values(data.private_messages[k]).forEach(m => { if (m.sender !== myId && m.status !== 'read') unread++; });
            });
            const el = document.getElementById('chat-counter');
            el.innerText = unread;
            el.style.display = unread > 0 ? 'inline-flex' : 'none';
        });
    }

    // Admin Logic
    let clicks = 0;
    document.getElementById('main-logo').onclick = () => {
        clicks++;
        if (clicks === 3) { if (prompt("–ü–∞—Ä–æ–ª—å:") === "Gazik0303") openAdmin(); clicks = 0; }
        setTimeout(() => clicks = 0, 1000);
    };

    function openAdmin() { document.getElementById('admin-overlay').style.display = 'flex'; loadLogs(); }
    function closeAdmin() { document.getElementById('admin-overlay').style.display = 'none'; }
    
    function loadLogs() {
        database.ref('visits').on('value', snap => {
            const container = document.getElementById('log-container');
            container.innerHTML = '';
            const all = snap.val() || {};
            Object.keys(all).sort().reverse().forEach(date => {
                container.innerHTML += `<div style="color:var(--main-gold); padding:10px 0; border-bottom:1px solid #333;">--- ${date} ---</div>`;
                Object.values(all[date]).forEach(v => {
                    if(!excludedIds.includes(v.userId)) container.innerHTML += `<div class="log-item"><b>${v.userId}</b> (x${v.count}) <span style="float:right">${v.time}</span></div>`;
                });
            });
        });
    }

    function addExclusion() { 
        const val = document.getElementById('exclude-input').value.trim();
        if(val) { database.ref('excluded_list').push(val); document.getElementById('exclude-input').value = ''; }
    }

    function renderExclusionTags() {
        const container = document.getElementById('excluded-tags');
        container.innerHTML = '';
        excludedIds.forEach(id => { container.innerHTML += `<span class="tag">${id}</span>`; });
    }

    function clearLogs() { if(confirm("–£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) database.ref('visits').remove(); }
    function openApp(name, url) { document.getElementById('overlay-title').innerText = name; document.getElementById('app-frame').src = url; document.getElementById('app-overlay').style.display = 'flex'; }
    function closeApp() { document.getElementById('app-overlay').style.display = 'none'; document.getElementById('app-frame').src = 'about:blank'; }

    document.addEventListener('DOMContentLoaded', initTracker);
</script>

<a href="https://chat.whatsapp.com/E10FzUdV9YLHem5KCVAQtQ?mode=gi_t" class="whatsapp-float" target="_blank">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WA">
</a>

</body>
</html>
